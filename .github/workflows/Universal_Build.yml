name: Universal WRT Build

on:
  workflow_dispatch:
    inputs:
      # 1. Выбор устройства
      target:
        description: 'Target Device'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - nanopi-r5s
          - slateax
          - ax59u
          - brume2
      
      # 2. Выбор источника (Immortal или Official)
      source:
        description: 'Source Code'
        required: true
        default: 'immortalwrt'
        type: choice
        options:
          - immortalwrt
          - openwrt
      
      # 3. Выбор ветки
      branch:
        description: 'Branch'
        required: true
        default: 'master'
        type: choice
        options:
          - master
          - openwrt-24.10
          - openwrt-25.12
      
      # 4. Выбор варианта сборки (Набор пакетов)
      variant:
        description: 'Build Variant'
        required: true
        default: 'passwall'
        type: choice
        options:
          - minimal      # Чистая сборка
          - passwall     # С Passwall 2
          - v2raya       # С v2rayA
          - xray         # С Xray (чистым)
      
      # 5. Опционально: Хеш коммита (если пусто - берет последний)
      commit_hash:
        description: 'Target Commit Hash (Optional, leave empty for latest)'
        required: false
        default: ''

env:
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: ./config/WRT.config
  DIY_P1_SH: ./sh/WRT-part1.sh
  DIY_P11_SH: ./sh/WRT-part11.sh
  DIY_P2_SH: ./sh/WRT-part2.sh
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: false
  TZ: Europe/Moscow

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          targets="nanopi-r5s slateax ax59u brume2"
          if [ "${{ github.event.inputs.target }}" == "all" ]; then
            selected=$targets
          else
            selected="${{ github.event.inputs.target }}"
          fi
          # Генерация JSON матрицы
          json="{\"include\":["
          first=true
          for t in $selected; do
            [ "$first" = false ] && json="$json,"
            json="$json{\"target\":\"$t\"}"
            first=false
          done
          json="$json]}"
          echo "matrix=$json" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    name: ${{ inputs.source }} ${{ inputs.branch }} [${{ inputs.variant }}] - ${{ matrix.target }}

    steps:
    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
        sudo apt-get autoremove -y && sudo apt-get clean
        df -h

    - name: Checkout
      uses: actions/checkout@main

    # --- Настройка прав (общая) ---
    - name: Set permissions
      run: |
        [ -d "./files/usr/bin" ] && chmod 755 ./files/usr/bin/*
        [ -d "./files/etc/uci-defaults" ] && chmod 755 ./files/etc/uci-defaults/* || true

    # --- Загрузка бинарников (общая) ---
    - name: Download binaries
      run: |
        # AdGuardHome
        curl -L -o AGH.tar.gz "https://github.com/AdguardTeam/AdGuardHome/releases/latest/download/AdGuardHome_linux_arm64.tar.gz"
        tar -xzf AGH.tar.gz
        mkdir -p ./files/usr/bin
        cp ./AdGuardHome/AdGuardHome ./files/usr/bin/ && chmod 755 ./files/usr/bin/AdGuardHome
        rm -rf AGH.tar.gz AdGuardHome
        
        # Sing-box
        SB_URL=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep "browser_download_url.*linux-arm64.tar.gz" | cut -d '"' -f 4 | head -n 1)
        curl -L -o sb.tar.gz "$SB_URL"
        tar -xzf sb.tar.gz
        cp sing-box-*/sing-box ./files/usr/bin/ && chmod 755 ./files/usr/bin/sing-box
        rm -rf sb.tar.gz sing-box-*

    # --- Настройка переменных на основе Inputs ---
    - name: Configure Build Variables
      run: |
        # 1. Настройка REPO_URL
        if [ "${{ inputs.source }}" == "immortalwrt" ]; then
          echo "REPO_URL=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_ENV
        else
          echo "REPO_URL=https://git.openwrt.org/openwrt/openwrt.git" >> $GITHUB_ENV
        fi
        
        # 2. Настройка REPO_BRANCH (Авто-подмена master -> main для OpenWrt)
        INPUT_BRANCH="${{ inputs.branch }}"
        
        if [ "$INPUT_BRANCH" == "master" ]; then
            if [ "${{ inputs.source }}" == "openwrt" ]; then
                echo ">>> Detected OpenWrt + master. Switching branch to 'main'."
                echo "REPO_BRANCH=main" >> $GITHUB_ENV
                # Для загрузки ядра (Kernel Hash) путь на сервере называется snapshots
                echo "TARGET_RELEASE=snapshots" >> $GITHUB_ENV
            else
                echo ">>> Detected ImmortalWrt + master."
                echo "REPO_BRANCH=master" >> $GITHUB_ENV
                echo "TARGET_RELEASE=snapshots" >> $GITHUB_ENV
            fi
        else
            # Если выбрана конкретная ветка (например, openwrt-24.10)
            echo "REPO_BRANCH=$INPUT_BRANCH" >> $GITHUB_ENV
            
            # Логика для TARGET_RELEASE (для скачивания хеша ядра)
            # Превращаем "openwrt-24.10" в "releases/24.10.0" (примерно)
            # Тут можно упростить: если ветка стабильная, пробуем сформировать путь
            if [[ "$INPUT_BRANCH" == *"25.12"* ]]; then
                 echo "TARGET_RELEASE=releases/25.12.0-rc2" >> $GITHUB_ENV
            elif [[ "$INPUT_BRANCH" == *"24.10"* ]]; then
                 # Для ImmortalWrt снапшоты релизных веток лежат специфично
                 if [ "${{ inputs.source }}" == "immortalwrt" ]; then
                    echo "TARGET_RELEASE=releases/24.10-SNAPSHOT" >> $GITHUB_ENV
                 else
                    echo "TARGET_RELEASE=releases/24.10.0" >> $GITHUB_ENV
                 fi
            fi
        fi

        # 3. Настройка устройства
        source ./config/conf/${{ matrix.target }}
        echo "TARGET_NAME=${TARGET_NAME}" >> $GITHUB_ENV
        echo "KERNEL_PATH=${KERNEL_PATH}" >> $GITHUB_ENV
        echo "DEVICE_CONFIG_COMMANDS<<EOF" >> $GITHUB_ENV
        echo "${DEVICE_CONFIG_COMMANDS}" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Init Env
      env: { DEBIAN_FRONTEND: noninteractive }
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/Gzxhwq/OpenWrt-Actions/main/depends-ubuntu-2204) build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget llvm python3-pyelftools libpython3-dev aria2 jq qemu-utils ccache rename libelf-dev device-tree-compiler libgmp3-dev libmpc-dev libfuse-dev
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir && sudo chown $USER:$GROUPS /workdir

    - name: Clone Source
      working-directory: /workdir
      run: |
        git clone --branch $REPO_BRANCH $REPO_URL openwrt
        cd openwrt
        # Обработка конкретного коммита, если он задан
        if [ -n "${{ inputs.commit_hash }}" ]; then
           echo "Checking out commit: ${{ inputs.commit_hash }}"
           git checkout ${{ inputs.commit_hash }}
        fi
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: Apply Patches
      run: |
        if [ -d "patches" ]; then
          for p in patches/*.patch; do
            [ -f "$p" ] && patch -p1 -d openwrt < "$p"
          done
        fi

    - name: Update Feeds & Config
      run: |
        cd openwrt
        [ -e $GITHUB_WORKSPACE/$FEEDS_CONF ] && cp $GITHUB_WORKSPACE/$FEEDS_CONF ./feeds.conf.default
        chmod +x $GITHUB_WORKSPACE/$DIY_P1_SH
        $GITHUB_WORKSPACE/$DIY_P1_SH
        
        # --- ЛОГИКА ВАРИАНТОВ (Passwall/v2rayA/etc) ---
        VARIANT="${{ inputs.variant }}"
        
        if [ "$VARIANT" == "passwall" ]; then
            echo -e "\nsrc-git passwall2 https://github.com/xiaorouji/openwrt-passwall2.git" >> feeds.conf.default
            echo -e "\nsrc-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git;main" >> feeds.conf.default
        elif [ "$VARIANT" == "v2raya" ]; then
            # Пример добавления фида для v2raya, если нужно
            # echo -e "\nsrc-git v2raya ..." >> feeds.conf.default
            :
        elif [ "$VARIANT" == "xray" ]; then
            echo -e "\nsrc-git luciappxray https://github.com/yichya/luci-app-xray.git" >> feeds.conf.default
        fi
        # ----------------------------------------------

        ./scripts/feeds update -a
        chmod +x $GITHUB_WORKSPACE/$DIY_P11_SH
        $GITHUB_WORKSPACE/$DIY_P11_SH
        ./scripts/feeds install -a
        
        [ -e $GITHUB_WORKSPACE/$CONFIG_FILE ] && cp $GITHUB_WORKSPACE/$CONFIG_FILE ./.config
        [ -e $GITHUB_WORKSPACE/files ] && cp -r $GITHUB_WORKSPACE/files ./
        
        # Внедрение конфига устройства
        eval "$DEVICE_CONFIG_COMMANDS"
        
        # --- ФИНАЛЬНАЯ НАСТРОЙКА .CONFIG В ЗАВИСИМОСТИ ОТ ВАРИАНТА ---
        echo "Applying config for variant: $VARIANT"
        
        # Чистка конфликтов
        sed -i '/homeproxy/d' ./.config
        sed -i '/sing-box/d' ./.config
        
        if [ "$VARIANT" == "passwall" ]; then
            echo 'CONFIG_PACKAGE_luci-app-passwall2=y' >> ./.config
            echo 'CONFIG_PACKAGE_luci-app-passwall2_Nftables_Transparent_Proxy=y' >> ./.config
            echo 'CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Xray=y' >> ./.config
            echo 'CONFIG_PACKAGE_xray-core=y' >> ./.config
            echo 'CONFIG_PACKAGE_geoview=y' >> ./.config
            # ... добавьте остальные опции Passwall сюда ...
            
        elif [ "$VARIANT" == "v2raya" ]; then
            echo 'CONFIG_PACKAGE_luci-app-v2raya=y' >> ./.config
            echo 'CONFIG_PACKAGE_v2rayA=y' >> ./.config
            echo 'CONFIG_PACKAGE_xray-core=y' >> ./.config
            
        elif [ "$VARIANT" == "xray" ]; then
            echo 'CONFIG_PACKAGE_luci-app-xray=y' >> ./.config
            echo 'CONFIG_PACKAGE_xray-core=y' >> ./.config
        fi
        
        # Запуск part2.sh
        chmod +x $GITHUB_WORKSPACE/$DIY_P2_SH
        $GITHUB_WORKSPACE/$DIY_P2_SH
        
        make defconfig

    # --- Шаг с ядром (Ваш умный скрипт) ---
    - name: Kernel Hash
      run: |
        cd openwrt
        # Определяем домен
        if [[ "${{ env.REPO_URL }}" == *"immortalwrt"* ]]; then
            DOMAIN="downloads.immortalwrt.org"
        else
            DOMAIN="downloads.openwrt.org"
        fi
        
        # Определяем путь релиза
        BRANCH="${{ inputs.branch }}"
        if [ "$BRANCH" == "master" ]; then
            PATH_SEGMENT="snapshots"
        elif [ "$BRANCH" == "openwrt-25.12" ]; then
            PATH_SEGMENT="releases/25.12.0-rc2" # Можно вынести в переменную
        else
            # Для 24.10 и прочих - пробуем releases или snapshots
            PATH_SEGMENT="releases/${BRANCH#openwrt-}-SNAPSHOT" 
            # Тут может потребоваться тонкая настройка URL, если имена релизов сложнее
        fi
        
        # Если мы на snapshot - URL простой
        if [ "$BRANCH" == "master" ]; then
             FULL_URL="https://$DOMAIN/snapshots/targets/${{ env.KERNEL_PATH }}/kmods/"
        else
             # Попытка универсального пути, но лучше проверить структуру папок на сервере
             # Для примера берем как для снапшотов релизных веток
             FULL_URL="https://$DOMAIN/releases/${BRANCH#openwrt-}-SNAPSHOT/targets/${{ env.KERNEL_PATH }}/kmods/"
        fi
        
        echo "Checking Kernel at: $FULL_URL"
        # ... (Ваш код curl/grep) ...
        # Вставьте сюда ваш проверенный код поиска хеша

    - name: Compile
      run: |
        cd openwrt
        make -j$(expr $(nproc) + 1) || make -j1 V=s
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Upload
      uses: actions/upload-artifact@main
      with:
        name: ${{ inputs.source }}_${{ inputs.branch }}_${{ inputs.variant }}_${{ matrix.target }}_${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2.0.6
      with:
        retain_days: 4
        keep_minimum_runs: 3