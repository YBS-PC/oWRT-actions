name: Universal WRT Build

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target Device'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - nanopi-r5s
          - slateax
          - ax59u
          - brume2
      
      source:
        description: 'Source Code'
        required: true
        default: 'immortalwrt'
        type: choice
        options:
          - immortalwrt
          - openwrt
      
      branch:
        description: 'Branch'
        required: true
        default: 'master'
        type: choice
        options:
          - master
          - openwrt-24.10
          - openwrt-25.12
      
      variant:
        description: 'Build Variant'
        required: true
        default: 'passwall'
        type: choice
        options:
          - minimal
          - passwall
          - v2raya
          - xray
      
      commit_hash:
        description: 'Target Commit Hash (Optional)'
        required: false
        default: ''

env:
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: ./config/WRT.config
  DIY_P1_SH: ./sh/WRT-part1.sh
  DIY_P11_SH: ./sh/WRT-part11.sh
  DIY_P2_SH: ./sh/WRT-part2.sh
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: false
  TZ: Europe/Moscow

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          targets="nanopi-r5s slateax ax59u brume2"
          if [ "${{ github.event.inputs.target }}" == "all" ]; then
            selected=$targets
          else
            selected="${{ github.event.inputs.target }}"
          fi
          json="{\"include\":["
          first=true
          for t in $selected; do
            [ "$first" = false ] && json="$json,"
            json="$json{\"target\":\"$t\"}"
            first=false
          done
          json="$json]}"
          echo "matrix=$json" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    
    name: ${{ inputs.source }} ${{ inputs.branch }} [${{ inputs.variant }}] - ${{ matrix.target }}

    steps:
    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
        sudo apt-get autoremove -y && sudo apt-get clean
        df -h

    - name: Checkout
      uses: actions/checkout@main

    - name: Set permissions
      run: |
        [ -d "./files/usr/bin" ] && chmod 755 ./files/usr/bin/*
        [ -d "./files/etc/uci-defaults" ] && chmod 755 ./files/etc/uci-defaults/* || true

    - name: Download binaries
      run: |
        # AdGuardHome
        curl -L -o AGH.tar.gz "https://github.com/AdguardTeam/AdGuardHome/releases/latest/download/AdGuardHome_linux_arm64.tar.gz"
        tar -xzf AGH.tar.gz
        mkdir -p ./files/usr/bin
        cp ./AdGuardHome/AdGuardHome ./files/usr/bin/ && chmod 755 ./files/usr/bin/AdGuardHome
        rm -rf AGH.tar.gz AdGuardHome
        
        # Sing-box
        SB_URL=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep "browser_download_url.*linux-arm64.tar.gz" | cut -d '"' -f 4 | head -n 1)
        curl -L -o sb.tar.gz "$SB_URL"
        tar -xzf sb.tar.gz
        cp sing-box-*/sing-box ./files/usr/bin/ && chmod 755 ./files/usr/bin/sing-box
        rm -rf sb.tar.gz sing-box-*

    - name: Configure Build Variables
      run: |
        # 1. URL Репозитория
        if [ "${{ inputs.source }}" == "immortalwrt" ]; then
          echo "REPO_URL=https://github.com/immortalwrt/immortalwrt.git" >> $GITHUB_ENV
        else
          echo "REPO_URL=https://git.openwrt.org/openwrt/openwrt.git" >> $GITHUB_ENV
        fi
        
        # 2. Ветка и Release Path
        INPUT_BRANCH="${{ inputs.branch }}"
        
        if [ "$INPUT_BRANCH" == "master" ]; then
            if [ "${{ inputs.source }}" == "openwrt" ]; then
                echo "REPO_BRANCH=main" >> $GITHUB_ENV
            else
                echo "REPO_BRANCH=master" >> $GITHUB_ENV
            fi
            echo "TARGET_RELEASE=snapshots" >> $GITHUB_ENV
        else
            echo "REPO_BRANCH=$INPUT_BRANCH" >> $GITHUB_ENV
            
            # Логика путей для стабильных релизов
            if [[ "$INPUT_BRANCH" == *"25.12"* ]]; then
                 echo "TARGET_RELEASE=releases/25.12.0-rc2" >> $GITHUB_ENV
            elif [[ "$INPUT_BRANCH" == *"24.10"* ]]; then
                 if [ "${{ inputs.source }}" == "immortalwrt" ]; then
                    # ImmortalWrt использует суффикс SNAPSHOT для стабильных веток в URL
                    echo "TARGET_RELEASE=releases/24.10-SNAPSHOT" >> $GITHUB_ENV
                 else
                    echo "TARGET_RELEASE=releases/24.10.0" >> $GITHUB_ENV
                 fi
            fi
        fi

        # 3. Устройство
        source ./config/conf/${{ matrix.target }}
        echo "TARGET_NAME=${TARGET_NAME}" >> $GITHUB_ENV
        echo "KERNEL_PATH=${KERNEL_PATH}" >> $GITHUB_ENV
        echo "DEVICE_CONFIG_COMMANDS<<EOF" >> $GITHUB_ENV
        echo "${DEVICE_CONFIG_COMMANDS}" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Init Env
      env: { DEBIAN_FRONTEND: noninteractive }
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/Gzxhwq/OpenWrt-Actions/main/depends-ubuntu-2204) build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget llvm python3-pyelftools libpython3-dev aria2 jq qemu-utils ccache rename libelf-dev device-tree-compiler libgmp3-dev libmpc-dev libfuse-dev
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir && sudo chown $USER:$GROUPS /workdir

    - name: Clone Source
      working-directory: /workdir
      run: |
        git clone --branch $REPO_BRANCH $REPO_URL openwrt
        cd openwrt
        if [ -n "${{ inputs.commit_hash }}" ]; then
           echo "Checking out commit: ${{ inputs.commit_hash }}"
           git checkout ${{ inputs.commit_hash }}
        fi
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: Apply Patches
      run: |
        if [ -d "patches" ]; then
          for p in patches/*.patch; do
            [ -f "$p" ] && patch -p1 -d openwrt < "$p"
          done
        fi

    - name: Update Feeds & Config
      run: |
        cd openwrt
        [ -e $GITHUB_WORKSPACE/$FEEDS_CONF ] && cp $GITHUB_WORKSPACE/$FEEDS_CONF ./feeds.conf.default
        chmod +x $GITHUB_WORKSPACE/$DIY_P1_SH
        $GITHUB_WORKSPACE/$DIY_P1_SH
        
        VARIANT="${{ inputs.variant }}"
        echo "Variant selected: $VARIANT"
        
        if [ "$VARIANT" == "passwall" ]; then
            echo -e "\nsrc-git passwall2 https://github.com/xiaorouji/openwrt-passwall2.git" >> feeds.conf.default
            echo -e "\nsrc-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git;main" >> feeds.conf.default
        elif [ "$VARIANT" == "xray" ]; then
            echo -e "\nsrc-git luciappxray https://github.com/yichya/luci-app-xray.git" >> feeds.conf.default
        fi

        ./scripts/feeds update -a
        chmod +x $GITHUB_WORKSPACE/$DIY_P11_SH
        $GITHUB_WORKSPACE/$DIY_P11_SH
        ./scripts/feeds install -a
        
        [ -e $GITHUB_WORKSPACE/$CONFIG_FILE ] && cp $GITHUB_WORKSPACE/$CONFIG_FILE ./.config
        [ -e $GITHUB_WORKSPACE/files ] && cp -r $GITHUB_WORKSPACE/files ./
        
        eval "$DEVICE_CONFIG_COMMANDS"
        
        # --- ФИНАЛЬНАЯ НАСТРОЙКА .CONFIG ---
        sed -i '/homeproxy/d' ./.config
        sed -i '/sing-box/d' ./.config
        
        if [ "$VARIANT" == "passwall" ]; then
            sed -i '/[Ss][Hh][Aa][Dd][Oo][Ww][Ss][Oo][Cc][Kk][Ss]/d' ./.config
            echo 'CONFIG_PACKAGE_luci-app-passwall2=y' >> ./.config
            echo 'CONFIG_PACKAGE_luci-app-passwall2_Nftables_Transparent_Proxy=y' >> ./.config
            echo 'CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_Xray=y' >> ./.config
            echo 'CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_IPv6_Nat=y' >> ./.config
            echo 'CONFIG_PACKAGE_luci-app-passwall2_INCLUDE_V2ray_Plugin=y' >> ./.config
            echo 'CONFIG_PACKAGE_xray-core=y' >> ./.config
            echo 'CONFIG_PACKAGE_geoview=y' >> ./.config
            echo 'CONFIG_PACKAGE_v2ray-plugin=y' >> ./.config
            echo 'CONFIG_PACKAGE_v2ray-geoip=y' >> ./.config
            echo 'CONFIG_PACKAGE_v2ray-geosite=y' >> ./.config
            
        elif [ "$VARIANT" == "v2raya" ]; then
            echo 'CONFIG_PACKAGE_luci-app-v2raya=y' >> ./.config
            echo 'CONFIG_PACKAGE_v2rayA=y' >> ./.config
            echo 'CONFIG_PACKAGE_v2ray-geodata=y' >> ./.config
            echo 'CONFIG_PACKAGE_xray-core=y' >> ./.config
            
        elif [ "$VARIANT" == "xray" ]; then
            echo 'CONFIG_PACKAGE_luci-app-xray=y' >> ./.config
            echo 'CONFIG_PACKAGE_xray-core=y' >> ./.config
            echo 'CONFIG_PACKAGE_v2ray-geoip=y' >> ./.config
            echo 'CONFIG_PACKAGE_v2ray-geosite=y' >> ./.config
        fi
        
        chmod +x $GITHUB_WORKSPACE/$DIY_P2_SH
        $GITHUB_WORKSPACE/$DIY_P2_SH
        
        make defconfig

    - name: Kernel Hash
      run: |
        cd openwrt
        if [[ "${{ env.REPO_URL }}" == *"immortalwrt"* ]]; then
            DOMAIN="downloads.immortalwrt.org"
        else
            DOMAIN="downloads.openwrt.org"
        fi
        
        FULL_URL="https://$DOMAIN/${{ env.TARGET_RELEASE }}/targets/${{ env.KERNEL_PATH }}/kmods/"
        
        echo "Checking Kernel at: $FULL_URL"
        
        KERNEL_LIST=$(curl -sf "$FULL_URL" | grep -oE '6\.[0-9]+\.[0-9]+-[0-9]+-[a-f0-9]+')
        
        if [ -z "$KERNEL_LIST" ]; then
             echo ">>> Warning: Kernel 6.x not found. Trying generic pattern..."
             KERNEL_LIST=$(curl -sf "$FULL_URL" | grep -oE '[0-9]\.[0-9]+\.[0-9]+-[0-9]+-[a-f0-9]+')
        fi

        LATEST_HASH=$(echo "$KERNEL_LIST" | while read -r line; do
            version=$(echo "$line" | cut -d'-' -f1)
            major=$(echo "$version" | cut -d'.' -f1)
            minor=$(echo "$version" | cut -d'.' -f2)
            patch=$(echo "$version" | cut -d'.' -f3)
            printf "%03d%03d%03d %s\n" "$major" "$minor" "$patch" "$line"
        done | sort -r | head -n1 | cut -d' ' -f2 | cut -d'-' -f3)
        
        if [ -z "$LATEST_HASH" ]; then
          echo "::error::Failed to get kernel hash. Check URL: $FULL_URL"
          exit 1
        fi
        
        echo "Latest hash is: ${LATEST_HASH}"
        sed -i "s/\$(MKHASH) md5/echo \"${LATEST_HASH}\"/g" include/kernel-defaults.mk

    - name: Compile
      run: |
        cd openwrt
        make -j$(expr $(nproc) + 1) || make -j1 V=s
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Upload
      uses: actions/upload-artifact@main
      with:
        name: ${{ inputs.source }}_${{ inputs.branch }}_${{ inputs.variant }}_${{ matrix.target }}_${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@v2.0.6
      with:
        retain_days: 4
        keep_minimum_runs: 3
